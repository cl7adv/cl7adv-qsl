<script>
  let totalQSLs = 0;
  let descargadas = 0;
  let listaActual = [];

  function buscarQSL() {
    const indicativo = document.getElementById("indicativo").value.trim().toUpperCase();
    const resultado = document.getElementById("resultado");

    if (!indicativo) {
      resultado.innerHTML = `<p class="mensaje">ğŸŒº Por favor escribe un indicativo ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;
      setTimeout(() => { resultado.innerHTML = ""; }, 5000);
      return;
    }

    let posibles = [];
    posibles.push(`img/${indicativo}.jpg`);
    for (let i = 1; i <= 50; i++) {
      posibles.push(`img/${indicativo}-${i}.jpg`);
    }

    let encontradas = [];

    posibles.forEach(ruta => {
      const img = new Image();
      img.src = ruta;
      img.onload = () => {
        encontradas.push(ruta);
      };
    });

    setTimeout(() => {
      if (encontradas.length > 0) {
        mostrarQSLs(encontradas, indicativo);
      } else {
        resultado.innerHTML = `<p class="mensaje">ğŸŒº No tenemos QSL para <strong>${indicativo}</strong>, pero tu visita siempre es bienvenida ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;
        setTimeout(() => {
          resultado.innerHTML = "";
          document.getElementById("indicativo").value = "";
        }, 5000);
      }
    }, 1500);
  }

  function mostrarQSLs(lista, indicativo) {
    const ventana = document.getElementById("ventanaQSL");
    const listaQSLs = document.getElementById("listaQSLs");
    const contador = document.getElementById("contador");

    listaQSLs.innerHTML = `<p>ğŸ“¡ Se encontraron ${lista.length} QSL para <strong>${indicativo}</strong></p>`;
    totalQSLs = lista.length;
    descargadas = 0;
    listaActual = lista;

    actualizarContador();

    lista.forEach(ruta => {
      listaQSLs.innerHTML += `
        <div>
          <img src="${ruta}" alt="QSL de ${indicativo}" class="qsl-img">
          <br>
          <a href="${ruta}" download class="descargar" onclick="marcarDescarga()">â¬‡ï¸ Descargar QSL</a>
        </div>
      `;
    });

    ventana.style.display = "block";
  }

  function actualizarContador() {
    const contador = document.getElementById("contador");
    contador.innerHTML = `<p class="mensaje">Has descargado ${descargadas} de ${totalQSLs} QSL</p>`;
  }

  function marcarDescarga() {
    descargadas++;
    actualizarContador();
    if (descargadas >= totalQSLs) {
      const listaQSLs = document.getElementById("listaQSLs");
      listaQSLs.innerHTML = `<p class="mensaje">âœ… Has descargado todas tus QSL, buenos DXs ğŸŒº ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;
      setTimeout(() => {
        cerrarVentana();
        document.getElementById("resultado").innerHTML = "";
        document.getElementById("indicativo").value = "";
      }, 2000);
    }
  }

  function descargarTodas() {
    listaActual.forEach(ruta => {
      const link = document.createElement("a");
      link.href = ruta;
      link.download = ruta.split("/").pop();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    descargadas = totalQSLs;
    actualizarContador();
    if (descargadas >= totalQSLs) {
      const listaQSLs = document.getElementById("listaQSLs");
      listaQSLs.innerHTML = `<p class="mensaje">âœ… Has descargado todas tus QSL, buenos DXs ğŸŒº ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;
      setTimeout(() => {
        cerrarVentana();
        document.getElementById("resultado").innerHTML = "";
        document.getElementById("indicativo").value = "";
      }, 2000);
    }
  }

  function cerrarVentana() {
    const ventana = document.getElementById("ventanaQSL");
    ventana.style.display = "none";
  }
</script>
