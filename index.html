<script>
  let totalQSLs = 0;
  let descargadas = 0;
  let listaActual = [];

  // Extensiones a probar por cada archivo
  const EXTENSIONES = ["jpg", "JPG", "png", "webp"];

  function buscarQSL() {
    const indicativo = document.getElementById("indicativo").value.trim().toUpperCase();
    const resultado = document.getElementById("resultado");

    if (!indicativo) {
      resultado.innerHTML = `<p class="mensaje">ğŸŒº Por favor escribe un indicativo ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;
      setTimeout(() => { resultado.innerHTML = ""; }, 4000);
      return;
    }

    // Generamos rutas potenciales: base + sufijos -i
    const bases = [`${indicativo}`, ...Array.from({ length: 50 }, (_, i) => `${indicativo}-${i + 1}`)];
    const posibles = [];

    // Rutas relativas explÃ­citas (./img/) y mÃºltiples extensiones
    bases.forEach(base => {
      EXTENSIONES.forEach(ext => posibles.push(`./img/${base}.${ext}`));
    });

    const encontradas = [];
    let pendientes = posibles.length;

    // Mensaje de bÃºsqueda
    resultado.innerHTML = `<p class="mensaje">ğŸ” Buscando QSL para <strong>${indicativo}</strong>â€¦ ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;

    posibles.forEach(ruta => {
      const img = new Image();
      img.onload = () => {
        // Evitar duplicar la misma QSL con distinta extensiÃ³n
        const nombre = ruta.replace(/\.(jpg|JPG|png|webp)$/, "");
        if (!encontradas.some(r => r.replace(/\.(jpg|JPG|png|webp)$/, "") === nombre)) {
          encontradas.push(ruta);
        }
      };
      img.onerror = () => { /* ignora errores individualmente */ };
      img.src = ruta;

      // Cuando termina el intento (carga o error), descontamos y decidimos
      img.onloadend = img.onerror = () => {
        pendientes--;
        if (pendientes === 0) {
          if (encontradas.length > 0) {
            mostrarQSLs(encontradas, indicativo);
            resultado.innerHTML = ""; // limpia mensaje de bÃºsqueda
          } else {
            resultado.innerHTML = `<p class="mensaje">ğŸŒº No tenemos QSL para <strong>${indicativo}</strong>, pero tu visita siempre es bienvenida ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;
            setTimeout(() => {
              resultado.innerHTML = "";
              document.getElementById("indicativo").value = "";
            }, 4000);
          }
        }
      };
    });
  }

  function mostrarQSLs(lista, indicativo) {
    const ventana = document.getElementById("ventanaQSL");
    const listaQSLs = document.getElementById("listaQSLs");
    const contador = document.getElementById("contador");

    listaQSLs.innerHTML = `<p>ğŸ“¡ Se encontraron ${lista.length} QSL para <strong>${indicativo}</strong></p>`;
    totalQSLs = lista.length;
    descargadas = 0;
    listaActual = lista.slice(); // copia defensiva

    actualizarContador();

    lista.forEach(ruta => {
      listaQSLs.innerHTML += `
        <div>
          <img src="${ruta}" alt="QSL de ${indicativo}" class="qsl-img">
          <br>
          <a href="${ruta}" download class="descargar" onclick="marcarDescarga()">â¬‡ï¸ Descargar QSL</a>
        </div>
      `;
    });

    ventana.style.display = "block";
  }

  function actualizarContador() {
    const contador = document.getElementById("contador");
    contador.innerHTML = `<p class="mensaje">Has descargado ${descargadas} de ${totalQSLs} QSL</p>`;
  }

  function marcarDescarga() {
    descargadas++;
    actualizarContador();
    if (descargadas >= totalQSLs) {
      const listaQSLs = document.getElementById("listaQSLs");
      listaQSLs.innerHTML = `<p class="mensaje">âœ… Has descargado todas tus QSL, buenos DXs ğŸŒº ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;
      setTimeout(() => {
        cerrarVentana();
        document.getElementById("resultado").innerHTML = "";
        document.getElementById("indicativo").value = "";
      }, 2000);
    }
  }

  function descargarTodas() {
    // Nota: algunos navegadores pueden limitar mÃºltiples descargas automÃ¡ticas
    listaActual.forEach(ruta => {
      const link = document.createElement("a");
      link.href = ruta;
      link.download = ruta.split("/").pop();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    descargadas = totalQSLs;
    actualizarContador();
    if (descargadas >= totalQSLs) {
      const listaQSLs = document.getElementById("listaQSLs");
      listaQSLs.innerHTML = `<p class="mensaje">âœ… Has descargado todas tus QSL, buenos DXs ğŸŒº ğŸ•Šï¸ğŸ•Šï¸ğŸ•Šï¸</p>`;
      setTimeout(() => {
        cerrarVentana();
        document.getElementById("resultado").innerHTML = "";
        document.getElementById("indicativo").value = "";
      }, 2000);
    }
  }

  function cerrarVentana() {
    const ventana = document.getElementById("ventanaQSL");
    ventana.style.display = "none";
  }
</script>

