<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Navegador QSL Caribe√±o - CL7ADV</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Nunito:wght@300;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: #fff8f2;
      --bg-2: #fff2e6;
      --accent: #c77a1a;
      --accent-600: #b25f12;
      --muted: #5a3f2b;
      --card-bg: #fffdf8;
      --glass: rgba(255,255,255,0.7);
      --shadow-1: 0 8px 30px rgba(80,40,10,0.08);
      --radius-lg: 16px;
      --radius-md: 10px;
      --transition-fast: 160ms;
      --transition-med: 260ms;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Nunito",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:
        radial-gradient(800px 400px at 10% 10%, rgba(255,230,200,0.6), transparent 12%),
        linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:var(--muted);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
      padding:28px 18px;
    }

    .container{
      max-width:980px;
      margin:0 auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,250,245,0.95));
      border-radius:var(--radius-lg);
      padding:28px;
      box-shadow: var(--shadow-1);
      border:1px solid rgba(180,120,60,0.06);
      overflow:hidden;
    }

    header{
      display:flex;
      gap:18px;
      align-items:center;
      margin-bottom:8px;
    }

    .logo{
      width:76px;
      height:76px;
      border-radius:12px;
      background: linear-gradient(180deg,#fff,#fff6ec);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 8px 22px rgba(160,100,40,0.08);
      border: 1px solid rgba(200,140,80,0.06);
      font-weight:800;
      color:var(--accent-600);
      font-family:"Playfair Display",serif;
      font-size:1.05rem;
    }

    h1{
      margin:0;
      font-family:"Playfair Display",serif;
      font-size:1.7rem;
      color:#4b3424;
      letter-spacing:0.2px;
    }

    p.lead{
      margin:6px 0 18px;
      color:#6f4f3a;
      font-size:1rem;
    }

    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    #indicativo{
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(120,80,40,0.08);
      width:240px;
      font-size:1rem;
      background: linear-gradient(180deg,#fff,#fffaf3);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
      color:var(--muted);
      outline: none;
      transition: box-shadow var(--transition-fast), transform var(--transition-fast);
    }
    #indicativo:focus{
      box-shadow: 0 6px 18px rgba(200,120,60,0.12);
      transform: translateY(-2px);
    }

    #buscarBtn{
      padding:12px 18px;
      border-radius:12px;
      border:none;
      background: linear-gradient(180deg,var(--accent),var(--accent-600));
      color:white;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(180,90,20,0.12);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    #buscarBtn:hover{ transform: translateY(-3px); box-shadow: 0 14px 34px rgba(180,90,20,0.16); }
    #buscarBtn:active{ transform: translateY(-1px); }

    #resultado{ margin-top:14px; min-height:40px; text-align:center; }

    .mensaje{ font-size:1rem; color:var(--accent-600); margin:8px 0; }

    /* QSL card */
    .qsl-img{
      max-width:240px;
      border-radius:12px;
      border: 3px solid rgba(200,140,80,0.12);
      box-shadow: 0 12px 30px rgba(120,70,30,0.08);
      background: linear-gradient(180deg,#fff,#fff8f2);
      transition: transform var(--transition-med), box-shadow var(--transition-med);
    }
    .qsl-img:hover{ transform: translateY(-6px); box-shadow: 0 20px 40px rgba(120,70,30,0.12); }

    .descargar{
      display:inline-block;
      margin-top:10px;
      padding:9px 16px;
      border-radius:10px;
      background: #5aa04a;
      color:#fff;
      text-decoration:none;
      font-weight:800;
      box-shadow: 0 8px 18px rgba(80,120,60,0.08);
      transition: transform var(--transition-fast);
    }
    .descargar:hover{ transform: translateY(-3px); }

    footer{
      margin-top:28px;
      text-align:center;
      color:#7a5a44;
      font-size:0.95rem;
    }

    /* Modal */
    .modal{ display:none; position:fixed; inset:0; z-index:1200; background: rgba(20,12,8,0.45); align-items:center; justify-content:center; padding:20px; }
    .modal-contenido{
      width:100%;
      max-width:920px;
      background: linear-gradient(180deg,#fffaf0,#fff7ef);
      border-radius:14px;
      padding:18px;
      box-shadow: 0 20px 50px rgba(60,30,10,0.25);
      color:#3f2b1f;
    }
    .cerrar{ float:right; font-size:26px; cursor:pointer; color:#7a5a44; }

    #listaQSLs{ display:flex; flex-wrap:wrap; gap:18px; justify-content:center; margin-top:12px; }

    /* Loader */
    .loader-wrap{ display:none; margin-top:12px; align-items:center; justify-content:center; gap:12px; }
    .spinner{ width:22px; height:22px; border:3px solid rgba(120,80,40,0.12); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .progress-bar{ position:relative; width:380px; height:14px; background: rgba(200,140,80,0.08); border-radius:10px; overflow:hidden; box-shadow: inset 0 2px 6px rgba(0,0,0,0.04); }
    .progress-fill{ height:100%; background: linear-gradient(90deg,#ffd89a,#ffb74d); width:0%; transition: width 160ms ease; }

    .card-thumb{
      position:absolute; top:-30px; width:64px; height:40px;
      background: linear-gradient(180deg,#fff,#fff0df);
      color:#4a2f1a; border:2px solid rgba(200,140,80,0.18);
      border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:0.85rem; box-shadow: 0 8px 22px rgba(120,70,30,0.12);
      transform:translateX(-50%); transition:left 100ms cubic-bezier(.2,.8,.2,1); pointer-events:none;
      overflow:hidden;
    }
    .card-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .progress-text{ font-size:0.95rem; color:#7a5a44; margin-top:8px; text-align:center; }

    @media (max-width:640px){
      .progress-bar{ width:260px; }
      #indicativo{ width:160px; }
      .logo{ width:60px; height:60px; font-size:0.95rem; }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <div class="logo" aria-hidden="true">CL7</div>
      <div>
        <h1>Navegador QSL Caribe√±o</h1>
        <p class="lead">Busca y descarga tus QSL con estilo c√°lido y profesional</p>
      </div>
    </header>

    <div class="controls" aria-label="Controles de b√∫squeda">
      <input id="indicativo" type="text" placeholder="Ej: CL7ADV" aria-label="Indicativo">
      <button id="buscarBtn" type="button">Buscar QSL</button>
    </div>

    <div id="loaderContainer" class="loader-wrap" aria-hidden="true">
      <div class="spinner" id="spinner" role="status" aria-hidden="true"></div>
      <div>
        <div class="progress-bar" id="progressBar">
          <div id="progressFill" class="progress-fill" style="width:0%"></div>
          <!-- Si subes img/mini-qsl.jpg se mostrar√° dentro de la carta -->
          <div id="cardThumb" class="card-thumb" style="left:0%"><img id="cardThumbImg" src="img/mini-qsl.jpg" alt="mini QSL" onerror="this.style.display='none'; this.parentElement.textContent='QSL'"></div>
        </div>
        <div id="progressText" class="progress-text">Iniciando b√∫squeda...</div>
      </div>
    </div>

    <div id="resultado" role="status" aria-live="polite"></div>

    <footer>
      ‚Äî CL7ADV ‚Äî Buenos DXs en este 2026 ¬∑ Radio Club Santa Cruz Del Sur/Alfred
    </footer>
  </div>

  <div id="ventanaQSL" class="modal" aria-hidden="true">
    <div class="modal-contenido" role="dialog" aria-modal="true" aria-labelledby="qslTitle">
      <span class="cerrar" id="cerrarBtn" title="Cerrar">&times;</span>
      <h2 id="qslTitle">QSLs disponibles</h2>
      <div id="contador"></div>
      <div id="listaQSLs"></div>
      <br>
      <button class="descargar" id="descargarTodasBtn" type="button">‚¨áÔ∏è Descargar todas</button>
    </div>
  </div>

  <script>
    let totalQSLs = 0, descargadas = 0, listaActual = [], imagenCargada = false, timeoutId = null;

    window.onerror = function(message, source, lineno, colno, error) {
      console.error('ERROR GLOBAL:', message, 'at', source + ':' + lineno + ':' + colno);
      const resultado = document.getElementById('resultado');
      if (resultado) resultado.innerHTML = `<p class="mensaje">‚ö†Ô∏è Error: ${message} (ver consola)</p>`;
      return false;
    };

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('buscarBtn').addEventListener('click', buscarQSL);
      document.getElementById('cerrarBtn').addEventListener('click', cerrarVentana);
      document.getElementById('descargarTodasBtn').addEventListener('click', descargarTodas);
      document.getElementById('ventanaQSL').addEventListener('click', (e) => {
        if (e.target === document.getElementById('ventanaQSL')) cerrarVentana();
      });
    });

    function animateCardTo(cardElem, targetPct, duration = 100) {
      if (!cardElem) return;
      if (cardElem._animFrame) cancelAnimationFrame(cardElem._animFrame);
      const start = parseFloat(cardElem.style.left) || 0;
      const end = Math.max(0, Math.min(100, targetPct));
      const startTime = performance.now();
      function ease(t){ return t<0.5 ? 2*t*t : -1 + (4 - 2*t)*t; }
      function step(now){
        const t = Math.min(1, (now - startTime) / duration);
        const eased = ease(t);
        const current = start + (end - start) * eased;
        cardElem.style.left = current + '%';
        if (t < 1) cardElem._animFrame = requestAnimationFrame(step);
        else cardElem._animFrame = null;
      }
      cardElem._animFrame = requestAnimationFrame(step);
    }

    function buscarQSL(){
      imagenCargada = false;
      if (timeoutId){ clearTimeout(timeoutId); timeoutId = null; }

      const indicativo = document.getElementById("indicativo").value.trim().toUpperCase();
      const resultado = document.getElementById("resultado");
      const listaQSLs = document.getElementById("listaQSLs");
      resultado.innerHTML = ""; listaQSLs.innerHTML = "";

      if (!indicativo){
        resultado.innerHTML = `<p class="mensaje">üå∫ Por favor escribe un indicativo</p>`;
        setTimeout(()=>{ resultado.innerHTML = ""; }, 4500);
        return;
      }

      const loader = document.getElementById('loaderContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const cardThumb = document.getElementById('cardThumb');
      loader.style.display = 'flex'; loader.setAttribute('aria-hidden','false');
      progressFill.style.width = '0%'; cardThumb.style.left = '0%';
      progressText.textContent = 'üîÑ Buscando QSL‚Ä¶';

      let posibles = []; posibles.push(`img/${indicativo}.jpg`);
      for (let i=1;i<=50;i++) posibles.push(`img/${indicativo}-${i}.jpg`);

      let encontradas = [], comprobadas = 0, totalPosibles = posibles.length;
      if (timeoutId) clearTimeout(timeoutId);

      function actualizarProgreso(){
        const pct = Math.round((comprobadas / totalPosibles) * 100);
        progressFill.style.width = pct + '%';
        const offset = 12;
        const cardPos = Math.min(100, pct + offset);
        animateCardTo(cardThumb, cardPos, 90);
        progressText.textContent = `Comprobadas ${comprobadas} / ${totalPosibles} (${pct}%)`;
      }

      posibles.forEach(ruta=>{
        const img = new Image();
        img.onload = ()=>{
          comprobadas++; actualizarProgreso();
          if (!encontradas.includes(ruta)){
            imagenCargada = true; encontradas.push(ruta);
            mostrarQSLs(encontradas, indicativo);
            progressFill.style.width = '100%';
            animateCardTo(cardThumb, 100, 90);
            progressText.textContent = `Se encontraron ${encontradas.length} QSL`;
            setTimeout(()=>{ loader.style.display='none'; loader.setAttribute('aria-hidden','true'); }, 700);
          }
        };
        img.onerror = ()=>{
          comprobadas++; actualizarProgreso();
          if (comprobadas >= totalPosibles && !imagenCargada){
            setTimeout(()=>{ loader.style.display='none'; loader.setAttribute('aria-hidden','true'); }, 300);
          }
        };
        img.src = ruta;
      });

      timeoutId = setTimeout(()=>{
        if (!imagenCargada){
          resultado.innerHTML = `<p class="mensaje">‚ùå No tenemos esa QSL, pero pronto estar√° lista üå∫</p>`;
          progressText.textContent = 'B√∫squeda finalizada: no se encontraron im√°genes';
          setTimeout(()=>{ loader.style.display='none'; loader.setAttribute('aria-hidden','true'); }, 900);
        }
      }, 10000);
    }

    function mostrarQSLs(lista, indicativo){
      const ventana = document.getElementById("ventanaQSL");
      const listaQSLs = document.getElementById("listaQSLs");
      if (!lista || lista.length===0) return;
      listaQSLs.innerHTML = `<p class="mensaje">üì° Se encontraron ${lista.length} QSL para <strong>${indicativo}</strong></p>`;
      totalQSLs = lista.length; descargadas = 0; listaActual = lista.slice();
      actualizarContador();
      lista.forEach(ruta=>{
        listaQSLs.innerHTML += `
          <div>
            <img src="${ruta}" alt="QSL de ${indicativo}" class="qsl-img">
            <br>
            <a href="${ruta}" download class="descargar" onclick="marcarDescarga()">‚¨áÔ∏è Descargar QSL</a>
          </div>
        `;
      });
      ventana.style.display = "flex"; ventana.setAttribute('aria-hidden','false');
    }

    function actualizarContador(){
      const contador = document.getElementById("contador");
      contador.innerHTML = `<p class="mensaje">Has descargado ${descargadas} de ${totalQSLs} QSL</p>`;
    }

    function marcarDescarga(){
      descargadas++; actualizarContador();
      if (descargadas >= totalQSLs){
        const listaQSLs = document.getElementById("listaQSLs");
        listaQSLs.innerHTML = `<p class="mensaje">‚úÖ Has descargado todas tus QSL, buenos DXs üå∫</p>`;
        setTimeout(()=>{ cerrarVentana(); document.getElementById("resultado").innerHTML=""; document.getElementById("indicativo").value=""; }, 1600);
      }
    }

    function descargarTodas(){
      if (!listaActual || listaActual.length===0) return;
      listaActual.forEach(ruta=>{
        const link = document.createElement("a");
        link.href = ruta; link.download = ruta.split("/").pop();
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
        descargadas++;
      });
      actualizarContador();
      if (descargadas >= totalQSLs){
        const listaQSLs = document.getElementById("listaQSLs");
        listaQSLs.innerHTML = `<p class="mensaje">‚úÖ Has descargado todas tus QSL, buenos DXs üå∫</p>`;
        setTimeout(()=>{ cerrarVentana(); document.getElementById("resultado").innerHTML=""; document.getElementById("indicativo").value=""; }, 1600);
      }
    }

    function cerrarVentana(){
      const ventana = document.getElementById("ventanaQSL");
      ventana.style.display = "none"; ventana.setAttribute('aria-hidden','true');
    }
  </script>
</body>
</html>
