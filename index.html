<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Zona Caribeña QSL - CL7ADV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- JSZip para la descarga de paquetes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --caribbean-cyan: #00f2ff;
            --caribbean-pink: #ff007a;
            --caribbean-gold: #ffcc00;
            --deep-ocean: #000814;
            --glass-bg: rgba(0, 15, 30, 0.92);
            --border-glow: rgba(0, 242, 255, 0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            font-family: 'Segoe UI', 'Orbitron', sans-serif; 
            background: var(--deep-ocean); 
            color: #fff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh;
            overflow: hidden;
        }

        #bg-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* --- AMANECER CARIBEÑO --- */
        #sunrise-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #001a2e, #fb8c00, #ffeb3b);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeOutSunrise 4s forwards;
            animation-delay: 2s;
            pointer-events: none;
        }

        .sun {
            width: 150px; height: 150px;
            background: #fffde7;
            border-radius: 50%;
            box-shadow: 0 0 100px #ffeb3b;
            transform: translateY(100px);
            animation: rise 3s ease-out forwards;
        }

        @keyframes rise { to { transform: translateY(-50px); } }
        @keyframes fadeOutSunrise { to { opacity: 0; visibility: hidden; } }

        /* --- MARCA DE AGUA --- */
        .station-copyright {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 0.65rem;
            color: var(--caribbean-cyan);
            letter-spacing: 3px;
            z-index: 1000;
            text-transform: uppercase;
            font-weight: 900;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-left: 3px solid var(--caribbean-pink);
        }

        /* --- CONTADOR DE VISITAS (MODIFICADO) --- */
        .visitor-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 15, 30, 0.8);
            padding: 5px;
            border-radius: 8px;
            border: 1px solid var(--border-glow);
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
        }
        .visitor-counter:hover {
            transform: scale(1.05);
        }
        .visitor-counter img {
            display: block;
            max-height: 80px; /* Ajuste para que no sea invasivo */
            width: auto;
        }

        /* --- INDICADOR DE INACTIVIDAD --- */
        #inactivity-timer {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 0.7rem;
            color: var(--caribbean-pink);
            background: rgba(0,0,0,0.6);
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 0, 122, 0.3);
            z-index: 1000;
            display: none;
        }

        /* --- PANTALLA DE BIENVENIDA --- */
        #welcome-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #001a2e 0%, #000 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.8s cubic-bezier(0.87, 0, 0.13, 1);
        }

        .radar-circle {
            position: absolute;
            width: 600px; height: 600px;
            border: 1px solid rgba(0, 242, 255, 0.1);
            border-radius: 50%;
        }
        .radar-sweep {
            position: absolute;
            width: 300px; height: 300px;
            background: conic-gradient(from 0deg, transparent 270deg, rgba(0, 242, 255, 0.3) 360deg);
            top: 50%; left: 50%;
            transform-origin: 0 0;
            animation: sweep 4s linear infinite;
            border-radius: 0 100% 0 0;
        }
        @keyframes sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .main-title {
            font-size: clamp(1.5rem, 5vw, 3rem);
            font-weight: 900;
            text-transform: uppercase;
            background: linear-gradient(to bottom, #fff 40%, var(--caribbean-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 6px;
            margin-bottom: 5px;
            text-align: center;
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.5));
        }

        .subtitle {
            font-size: 0.9rem;
            letter-spacing: 4px;
            color: var(--caribbean-pink);
            text-transform: uppercase;
            font-weight: bold;
            margin-bottom: 40px;
            text-align: center;
        }

        #start-app {
            padding: 18px 45px;
            background: transparent;
            color: #fff;
            border: 2px solid var(--caribbean-cyan);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 4px;
            border-radius: 4px;
            font-weight: bold;
            z-index: 10;
        }
        #start-app:hover { background: var(--caribbean-cyan); color: #000; box-shadow: 0 0 30px var(--caribbean-cyan); }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container { 
            width: 95%; max-width: 1000px; padding: 30px; 
            background: var(--glass-bg); border-radius: 12px;
            border: 1px solid var(--border-glow); text-align: center;
            display: none; backdrop-filter: blur(20px);
            max-height: 90vh; overflow-y: auto;
            position: relative;
            animation: terminal-open 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes terminal-open { from { opacity: 0; transform: scale(0.9) translateY(40px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        #search-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
            color: var(--caribbean-cyan); letter-spacing: 5px;
        }

        .search-area { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .search-area { grid-template-columns: 3fr 1fr; } }

        #indicativo { 
            padding: 15px; font-size: 1.8rem; border: 1px solid rgba(0, 242, 255, 0.3); 
            background: rgba(0,0,0,0.5); color: var(--caribbean-cyan); font-weight: 900; 
            text-transform: uppercase; text-align: center; width: 100%; border-radius: 4px;
            outline: none;
        }
        #indicativo:focus { border-color: var(--caribbean-cyan); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }

        #buscarBtn { 
            padding: 18px 40px; background: var(--caribbean-pink); 
            color: #fff; border: none; cursor: pointer; font-weight: 900; 
            text-transform: uppercase; border-radius: 4px; transition: 0.3s;
        }
        #buscarBtn:hover { transform: scale(1.02); filter: brightness(1.2); }

        #resultado { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; margin-top: 30px; }
        
        .qsl-card { 
            background: rgba(255, 255, 255, 0.02); padding: 12px; 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
            transition: 0.3s;
        }
        .qsl-card:hover { border-color: var(--caribbean-cyan); transform: translateY(-5px); }
        .qsl-card img { width: 100%; border-radius: 4px; cursor: pointer; margin-bottom: 10px; display: block; }
        
        .btn-individual { width: 100%; padding: 10px; background: transparent; color: #fff; border: 1px solid var(--caribbean-cyan); cursor: pointer; font-size: 0.8rem; border-radius: 4px; }
        .btn-individual:hover { background: var(--caribbean-cyan); color: #000; }

        .action-btns { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        #btnZip, #btnVolver { padding: 16px 30px; border: none; font-weight: 900; cursor: pointer; display: none; border-radius: 4px; text-transform: uppercase; }
        #btnZip { background: #fff; color: #000; }
        #btnVolver { background: rgba(255,255,255,0.1); color: #fff; }

        .loader-spin {
            width: 50px; height: 50px; border: 3px solid transparent;
            border-top-color: var(--caribbean-cyan); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Notificación de gracias */
        #thanks-msg {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: var(--caribbean-cyan); color: #000; padding: 10px 25px;
            border-radius: 4px; font-weight: 900; letter-spacing: 1px;
            display: none; z-index: 5000; animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

        footer { margin-top: 40px; font-size: 0.65rem; color: #3d5a69; letter-spacing: 2px; line-height: 1.5; }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div id="sunrise-layer"><div class="sun"></div></div>

    <div class="station-copyright">CL7ADV // DX-TERMINAL</div>

    <!-- NUEVO CONTADOR DE BANDERAS -->
    <div class="visitor-counter">
        <a href="https://info.flagcounter.com/BrfY">
            <img src="https://s01.flagcounter.com/count2/BrfY/bg_26A8FF/txt_000000/border_FF1259/columns_2/maxflags_15/viewers_0/labels_0/pageviews_0/flags_0/percent_0/" alt="Flag Counter" border="0">
        </a>
    </div>
    
    <div id="inactivity-timer">REINICIO EN: <span id="time-left">10</span>s</div>

    <div id="thanks-msg">¡GRACIAS POR DESCARGAR! 73s</div>

    <!-- PANTALLA CARGA/BÚSQUEDA -->
    <div id="search-overlay">
        <div class="loader-spin"></div>
        <div id="overlay-text">ACCEDIENDO A LA BASE DE DATOS...</div>
    </div>

    <!-- BIENVENIDA -->
    <div id="welcome-screen">
        <div class="radar-circle"></div>
        <div class="radar-sweep"></div>
        <div class="welcome-msg">
            <div class="main-title">BIENVENIDOS COLEGAS RADIOPERADORES</div>
            <div class="subtitle">CARIBBEAN QSL NETWORK • 73's DE CL7ADV</div>
            <button id="start-app">ENTRAR A LA TERMINAL</button>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div class="container" id="main-container">
        <div class="header-box">
            <h1 style="color:var(--caribbean-cyan); letter-spacing:5px; margin-bottom: 30px; text-shadow: 0 0 20px var(--caribbean-cyan);">ZONA CARIBEÑA</h1>
        </div>

        <div id="search-interface">
            <div class="search-area">
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <input type="text" id="indicativo" placeholder="CALLSIGN (Ej: CO7ZZ)" maxlength="15" autocomplete="off">
                    <button id="buscarBtn">CONSULTAR QSL</button>
                </div>
                <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:5px; text-align:left; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size:0.6rem; color:#5a7d8c; margin-bottom: 8px;">LOGS RECIENTES</div>
                    <ul id="history-list" style="list-style:none; padding:0; font-size:0.8rem; color:var(--caribbean-cyan);"></ul>
                </div>
            </div>
        </div>

        <div id="resultado"></div>

        <div class="action-btns">
            <button id="btnZip">DESCARGAR PACK (.ZIP)</button>
            <button id="btnVolver">NUEVA CONSULTA</button>
        </div>

        <footer>
            73'S DE CL7ADV • ALFRED • CAMAGÜEY, CUBA<br>
            <span style="opacity: 0.4;">SISTEMA DE GESTIÓN DE TARJETAS QSL // 2026</span>
        </footer>
    </div>

<script>
// CONFIGURACIÓN DE GITHUB
const REPO_URL = "https://raw.githubusercontent.com/cl7adv/cl7adv-qsl/main/img/";

let historyData = JSON.parse(localStorage.getItem('qsl_history') || '[]');
let inactivityTimer;
let countdownInterval;
let timeLeft = 10;
let isAppStarted = false;

// --- SISTEMA DE INACTIVIDAD (10 SEGUNDOS) ---
function resetInactivity() {
    if (!isAppStarted) return;
    
    document.getElementById('inactivity-timer').style.display = "none";
    clearInterval(countdownInterval);
    clearTimeout(inactivityTimer);
    
    inactivityTimer = setTimeout(startCountdown, 20000); 
}

function startCountdown() {
    timeLeft = 10;
    document.getElementById('inactivity-timer').style.display = "block";
    document.getElementById('time-left').innerText = timeLeft;
    
    countdownInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('time-left').innerText = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            returnToStart();
        }
    }, 1000);
}

function returnToStart() {
    isAppStarted = false;
    location.reload();
}

// Escuchar actividad
['mousedown', 'mousemove', 'keypress', 'touchstart'].forEach(evt => {
    window.addEventListener(evt, resetInactivity);
});

// --- EFECTO DE PARTÍCULAS (Canvas) ---
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');
let particles = [];
const mouse = { x: -100, y: -100 };

window.addEventListener('mousemove', (e) => {
    mouse.x = e.x;
    mouse.y = e.y;
});

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

class Particle {
    constructor() {
        this.reset();
    }
    reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.size = Math.random() * 2 + 0.5;
        this.speedX = Math.random() * 0.5 - 0.25;
        this.speedY = Math.random() * 0.5 - 0.25;
        this.opacity = Math.random() * 0.5;
    }
    update() {
        this.x += this.speedX;
        this.y += this.speedY;
        const dx = mouse.x - this.x;
        const dy = mouse.y - this.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 100) {
            this.x -= dx / 50;
            this.y -= dy / 50;
        }
        if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) this.reset();
    }
    draw() {
        ctx.fillStyle = `rgba(0, 242, 255, ${this.opacity})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

function initParticles() {
    for (let i = 0; i < 100; i++) particles.push(new Particle());
}

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
        p.update();
        p.draw();
    });
    requestAnimationFrame(animateParticles);
}

// INICIAR TODO
initParticles();
animateParticles();

document.getElementById("start-app").addEventListener("click", () => {
    isAppStarted = true;
    document.getElementById("welcome-screen").style.opacity = "0";
    setTimeout(() => {
        document.getElementById("welcome-screen").style.display = "none";
        document.getElementById("main-container").style.display = "block";
        updateHistoryUI();
        resetInactivity();
    }, 800);
});

function updateHistoryUI() {
    const list = document.getElementById('history-list');
    list.innerHTML = historyData.slice(0,5).map(h => `<li style="cursor:pointer; margin-bottom:8px; border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom:4px;" onclick="quickSearch('${h}')">${h}</li>`).join('');
}

function quickSearch(call) {
    document.getElementById('indicativo').value = call;
    document.getElementById('buscarBtn').click();
}

function generarRutas(call) {
    const formatos = ["jpg", "png", "pmg", "jpeg", "JPG", "PNG", "PMG"];".JPG"];
    const variantes = ["", "-1", "-2", "-3", "-4", "-5", "-6", "-7", "_1", "_2", "_QSL"];
    let rutas = [];
    formatos.forEach(ext => {
        variantes.forEach(v => {
            rutas.push(`${REPO_URL}${call}${v}.${ext}`);
        });
    });
    return rutas;
}

function probarImagen(src) {
    return new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => resolve(src);
        img.onerror = () => resolve(null);
        img.src = src;
    });
}

function showThanks() {
    const msg = document.getElementById('thanks-msg');
    msg.style.display = 'block';
    setTimeout(() => {
        msg.style.display = 'none';
    }, 3000);
}

document.getElementById("buscarBtn").addEventListener("click", async () => {
    const call = document.getElementById('indicativo').value.trim().toUpperCase();
    if (!call) return;

    if(!historyData.includes(call)) {
        historyData.unshift(call);
        localStorage.setItem('qsl_history', JSON.stringify(historyData));
        updateHistoryUI();
    }

    const overlay = document.getElementById("search-overlay");
    overlay.style.display = "flex";
    document.getElementById("search-interface").style.display = "none";
    document.getElementById("resultado").innerHTML = "";

    const rutas = generarRutas(call);
    const resultados = await Promise.all(rutas.map(probarImagen));
    const encontradas = [...new Set(resultados.filter(x => x !== null))];

    overlay.style.display = "none";
    mostrarResultados(encontradas, call);
});

function mostrarResultados(encontradas, call) {
    const res = document.getElementById('resultado');
    if (encontradas.length === 0) {
        res.innerHTML = `
            <div style="grid-column: 1/-1; color:var(--caribbean-pink); padding:40px; border:1px dashed var(--caribbean-pink); background: rgba(255,0,122,0.05);">
                <div style="font-size: 2rem; margin-bottom: 10px;">⚠️</div>
                SIN REGISTROS PARA: <strong>${call}</strong><br>
                <small style="opacity:0.7; margin-top:10px; display:block;">Verifique el indicativo o intente más tarde.</small>
            </div>`;
    } else {
        encontradas.forEach((src) => {
            const fileName = src.split('/').pop();
            const card = document.createElement('div');
            card.className = 'qsl-card';
            card.innerHTML = `
                <div style="font-size:0.6rem; color:var(--caribbean-cyan); margin-bottom:5px; text-align:left; opacity:0.6;">REF: ${fileName}</div>
                <img src="${src}" title="Click para ampliar" onclick="window.open('${src}')">
                <button class="btn-individual" onclick="descargarIndividual('${src}')">GUARDAR IMAGEN</button>
            `;
            res.appendChild(card);
        });
        document.getElementById("btnZip").style.display = "block";
    }
    document.getElementById("btnVolver").style.display = "block";
}

async function descargarIndividual(url) {
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = url.split('/').pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        showThanks();
    } catch (e) {
        window.open(url, '_blank');
        showThanks();
    }
}

document.getElementById("btnVolver").addEventListener("click", () => {
    document.getElementById("search-interface").style.display = "block";
    document.getElementById("resultado").innerHTML = "";
    document.getElementById("btnZip").style.display = "none";
    document.getElementById("btnVolver").style.display = "none";
    document.getElementById("indicativo").value = "";
    document.getElementById("indicativo").focus();
});

document.getElementById("btnZip").addEventListener("click", async () => {
    const btn = document.getElementById("btnZip");
    const originalText = btn.innerText;
    btn.innerText = "PROCESANDO...";
    btn.disabled = true;

    try {
        const imgs = document.querySelectorAll(".qsl-card img");
        const zip = new JSZip();
        for (let img of imgs) {
            const response = await fetch(img.src);
            const blob = await response.blob();
            zip.file(img.src.split('/').pop(), blob);
        }
        const content = await zip.generateAsync({type:"blob"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        link.download = `QSL_PACK_CL7ADV_${Date.now()}.zip`;
        link.click();
        showThanks();
    } catch (err) {
        console.error("Error al crear ZIP:", err);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
});

document.getElementById("indicativo").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("buscarBtn").click();
});
</script>
</body>
</html>
