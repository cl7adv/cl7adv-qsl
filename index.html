<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>QSL CARIBE v106 - DRIVE DEEP SEARCH</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --cyan: #00f2ff; --pink: #ff007b; --bg: #010409; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }

        /* --- CINEM√ÅTICA DE INICIO --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: 1.5s;
        }
        .scan-line { width: 100%; height: 2px; background: var(--cyan); position: absolute; top: 0; animation: moveScan 2s linear infinite; box-shadow: 0 0 20px var(--cyan); }
        @keyframes moveScan { 0% { top: 0; } 100% { top: 100%; } }
        
        .boot-text { font-family: 'Orbitron', sans-serif; color: var(--cyan); text-shadow: 0 0 10px var(--cyan); letter-spacing: 5px; }

        /* --- UI PRINCIPAL --- */
        #main-ui { opacity: 0; transition: 2s; display: none; }
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .glass-panel { background: rgba(13, 17, 23, 0.9); border-radius: 40px; padding: 40px; border: 1px solid rgba(0, 242, 255, 0.2); margin-bottom: 40px; text-align: center; }

        .supreme-input { width: 100%; padding: 25px; border-radius: 20px; background: #000; border: 2px solid #1e293b; color: var(--cyan); font-size: 2rem; font-weight: 800; text-align: center; font-family: 'Orbitron', sans-serif; margin-bottom: 20px; box-sizing: border-box; }

        .btn { padding: 20px 45px; border-radius: 50px; border: none; font-weight: 900; font-family: 'Orbitron', sans-serif; cursor: pointer; transition: 0.4s; text-transform: uppercase; letter-spacing: 2px; }
        .btn-cyan { background: var(--cyan); color: #000; }
        .btn-pink { background: var(--pink); color: #fff; }

        /* --- RADAR LOADER --- */
        #radar-container { display: none; margin: 20px auto; }
        .radar { width: 80px; height: 80px; border: 4px solid var(--cyan); border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- TUTORIAL --- */
        #tutorial-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 400px; background: var(--cyan); color: #000; padding: 20px; border-radius: 20px; font-weight: bold; z-index: 5000; display: none; text-align: center; box-shadow: 0 0 30px rgba(0,242,255,0.5); }

        .qsl-card { margin-top: 30px; border: 2px solid var(--cyan); border-radius: 20px; overflow: hidden; background: #000; animation: slideUp 0.8s forwards; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        #results img { width: 100%; display: block; }
    </style>
</head>
<body onload="initCinematic()">

    <audio id="snd-power" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="snd-scan" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" loop></audio>
    <audio id="snd-success" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <div id="intro-overlay">
        <div class="scan-line"></div>
        <h1 class="boot-text">SISTEMA CARIBE</h1>
        <p id="boot-status" style="font-family: monospace; color: #444;">INICIALIZANDO HARDWARE...</p>
        <button class="btn btn-cyan" id="connect-btn" style="display:none; margin-top:30px;" onclick="unlockUI()">CONECTAR AL NODO</button>
    </div>

    <div id="main-ui">
        <div class="container">
            <div class="glass-panel">
                <h2 style="font-family: 'Orbitron'; color: var(--cyan);">BUSCADOR DRIVE</h2>
                <input type="text" id="target-id" class="supreme-input" placeholder="INDICATIVO" oninput="checkInput(this.value)">
                <button class="btn btn-cyan" onclick="startCloudSearch()">INICIAR ESCANEO</button>
                
                <div id="radar-container">
                    <div class="radar"></div>
                    <p style="color:var(--cyan); font-family: 'Orbitron'; margin-top:15px;">RASTREANDO EN LA NUBE...</p>
                </div>
                
                <div id="results"></div>
            </div>

            <div class="glass-panel" style="border-color: var(--pink);">
                <h2 style="font-family: 'Orbitron'; color: var(--pink);">SISTEMA DE CARGA</h2>
                <input type="text" id="up-name" class="supreme-input" placeholder="NOMBRE" style="font-size: 1.2rem; border-color: #333;">
                <input type="file" id="up-file" style="margin: 20px 0;">
                <button class="btn btn-pink" onclick="secureUpload()">SUBIR A DRIVE</button>
            </div>
        </div>
    </div>

    <div id="tutorial-box">
        <p>üì° TUTORIAL: Escribe tu indicativo y el sistema buscar√° en Google Drive.</p>
        <button onclick="closeTut()" style="background:#000; color:#fff; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">ENTENDIDO</button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCs0GIz2_0jzlWbNXpoufBOUCPYOrkaUZCWGRolnUW4k8Nmuzs0TCRAKqOHhRUYF-i/exec";

        function initCinematic() {
            setTimeout(() => {
                document.getElementById('boot-status').innerText = "ENLACE SATELITAL LISTO";
                document.getElementById('connect-btn').style.display = "block";
                document.getElementById('snd-power').play();
            }, 3000);
        }

        function unlockUI() {
            document.getElementById('intro-overlay').style.opacity = "0";
            setTimeout(() => {
                document.getElementById('intro-overlay').style.display = "none";
                document.getElementById('main-ui').style.display = "block";
                setTimeout(() => { 
                    document.getElementById('main-ui').style.opacity = "1";
                    document.getElementById('tutorial-box').style.display = "block";
                }, 100);
            }, 1500);
        }

        function closeTut() { document.getElementById('tutorial-box').style.display = 'none'; }

        // --- L√ìGICA DE RETORNO AL INICIO ---
        function checkInput(val) {
            if (val === "") {
                clearSearch();
            }
        }

        function clearSearch() {
            document.getElementById('results').innerHTML = "";
            document.getElementById('radar-container').style.display = "none";
            // No se llama a tutorial-box, por lo que no vuelve a aparecer
        }

        async function startCloudSearch() {
            const id = document.getElementById('target-id').value.trim().toUpperCase();
            const results = document.getElementById('results');
            const radar = document.getElementById('radar-container');
            const snd = document.getElementById('snd-scan');

            if(!id) return;
            results.innerHTML = "";
            radar.style.display = "block";
            snd.play();

            // CARGA LENTA DE 4 SEGUNDOS
            await new Promise(r => setTimeout(r, 4000));

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "search", name: id })
                });
                const data = await response.json();

                radar.style.display = "none";
                snd.pause();
                snd.currentTime = 0;

                if (data.result === "success" && data.images.length > 0) {
                    document.getElementById('snd-success').play();
                    data.images.forEach(imgBase64 => {
                        results.innerHTML += `
                            <div class="qsl-card">
                                <img src="${imgBase64}">
                                <button class="btn btn-cyan" style="width:100%; border-radius:0;" onclick="downloadAndReset('${imgBase64}', '${id}')">DESCARGAR Y SALIR</button>
                            </div>`;
                    });
                } else {
                    results.innerHTML = "<p style='color:var(--pink)'>SIN SE√ëAL EN DRIVE</p>";
                }
            } catch (e) {
                radar.style.display = "none";
                snd.pause();
                alert("Error de enlace con Drive");
            }
        }

        function downloadAndReset(base64, name) {
            const link = document.createElement('a');
            link.href = base64;
            link.download = name + ".png";
            link.click();
            
            // Retorno al inicio: limpia input y resultados sin activar tutorial
            document.getElementById('target-id').value = "";
            clearSearch();
        }

        async function secureUpload() {
            const pass = prompt("LLAVE MAESTRA:");
            if(pass !== "Leila2026") return alert("BLOQUEADO");
            
            const name = document.getElementById('up-name').value.trim().toUpperCase();
            const fileEl = document.getElementById('up-file').files[0];
            if(!name || !fileEl) return alert("FALTAN DATOS");

            const reader = new FileReader();
            reader.readAsDataURL(fileEl);
            reader.onload = async function() {
                const payload = { 
                    base64: reader.result.split(',')[1], 
                    type: fileEl.type, 
                    name: name + ".png" 
                };
                try {
                    const resp = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
                    const res = await resp.json();
                    if(res.result === "success") {
                        document.getElementById('snd-success').play();
                        alert("‚úÖ GUARDADO EN DRIVE");
                        document.getElementById('up-name').value = "";
                        document.getElementById('up-file').value = "";
                    }
                } catch (e) { alert("‚ùå ERROR"); }
            };
        }
    </script>
</body>
</html>
