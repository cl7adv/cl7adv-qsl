<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CL7ADV | QSL MASTER STATION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --neon-green: #00ff41;
            --neon-blue: #00f2ff;
            --dark: #050505;
            --panel: #111;
            --warning: #f39c12;
        }

        body {
            background-color: var(--dark);
            color: var(--neon-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0; padding: 15px;
            overflow-x: hidden;
        }

        .main-layout {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .header {
            grid-column: 1 / -1;
            border-bottom: 2px solid var(--neon-green);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel {
            background: var(--panel);
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* --- VISUALIZADORES --- */
        #spectrogram { 
            width: 100%; height: 150px; 
            background: #000; border: 1px solid var(--neon-green);
        }

        .terminal {
            height: 200px; overflow-y: auto;
            padding: 15px; color: #fff;
            font-size: 1.4rem; background: #000;
            border: 1px solid #222; margin-top: 10px;
        }

        /* --- GALERÍA DE RESULTADOS --- */
        .qsl-display {
            margin-top: 20px;
            text-align: center;
        }

        .qsl-img-frame {
            max-width: 100%;
            border: 5px solid #fff;
            box-shadow: 0 0 20px rgba(0,242,255,0.3);
            margin-bottom: 15px;
            transition: transform 0.3s;
        }

        .qsl-img-frame:hover { transform: scale(1.02); }

        /* --- INTERFAZ --- */
        .hidden { display: none !important; }
        
        input[type="text"] {
            width: 100%; padding: 12px;
            background: #000; color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            margin-bottom: 10px; box-sizing: border-box;
            font-family: 'Orbitron';
        }

        button {
            width: 100%; padding: 12px;
            background: transparent; border: 1px solid var(--neon-green);
            color: var(--neon-green); font-family: 'Orbitron', sans-serif;
            cursor: pointer; transition: 0.3s;
        }

        button:hover { background: var(--neon-green); color: #000; }
        
        .btn-download { border-color: var(--warning); color: var(--warning); margin-top: 10px; }
        .btn-download:hover { background: var(--warning); color: #000; }

        #status-bar { font-size: 0.7rem; color: var(--neon-blue); }
    </style>
</head>
<body>

<div class="header">
    <h1 style="font-family:'Orbitron'; margin:0;">CL7ADV STATION MASTER</h1>
    <div id="status-bar">MODO: STANDBY</div>
</div>

<div class="main-layout">
    <div class="panel">
        <h3>SINTONIZADOR CW</h3>
        <button onclick="initAudio()">ENCENDER RECEPTOR</button>
        <div style="margin-top:15px; font-size:0.8rem;">
            FREQ: <span id="fVal">700</span>Hz | SQ: <span id="sVal">110</span>
            <input type="range" id="fSlider" min="400" max="1200" value="700" oninput="syncParams()">
        </div>

        <hr style="border:1px solid #222; margin:20px 0;">

        <h3>BÚSQUEDA EN REPOSITORIO</h3>
        <input type="text" id="qslInput" placeholder="CALLSIGN...">
        <button onclick="buscarQSL()">BUSCAR MI QSL</button>
        <div id="searchInfo" style="margin-top:10px; font-size:0.8rem; color:var(--warning);"></div>
    </div>

    <div class="panel">
        <canvas id="spectrogram"></canvas>
        <div class="terminal" id="term">INICIE AUDIO PARA DECODIFICAR...</div>

        <div id="results-area" class="hidden qsl-display">
            <h2 style="color:var(--neon-blue);">¡TARJETA ENCONTRADA!</h2>
            <div id="imgContainer">
                </div>
            <button class="btn-download" onclick="descargarMasivo()">DESCARGAR PACK QSL (.JPG)</button>
        </div>
    </div>
</div>

<script>
    // CONFIGURACIÓN DE TU CARPETA
    const CARPETA_IMAGENES = "img/CL7ADV-QSL/";
    let qslEncontradas = [];
    let timerReinicio;

    /**
     * FUNCIÓN DE BÚSQUEDA (CONEXIÓN CON CARPETA)
     */
    function buscarQSL() {
        const call = document.getElementById('qslInput').value.toUpperCase().trim();
        const info = document.getElementById('searchInfo');
        const area = document.getElementById('results-area');
        const container = document.getElementById('imgContainer');

        if(call === "") return;

        info.innerText = "ACCEDIENDO AL SERVIDOR...";
        qslEncontradas = [];
        container.innerHTML = "";

        // Intentamos cargar la imagen desde tu carpeta GitHub
        const urlImagen = CARPETA_IMAGENES + call + ".jpg";
        const img = new Image();
        img.src = urlImagen;

        img.onload = function() {
            info.innerText = "CONEXIÓN EXITOSA";
            area.classList.remove('hidden');
            
            // Crear el elemento visual de la QSL
            const frame = document.createElement('img');
            frame.src = urlImagen;
            frame.className = "qsl-img-frame";
            container.appendChild(frame);
            
            qslEncontradas.push(urlImagen);
            startInactivityTimer(); // Iniciamos tu timer de 6 seg
            
            // Log en la terminal
            document.getElementById('term').innerHTML += `<br>[SISTEMA] QSL PARA ${call} LOCALIZADA.`;
        };

        img.onerror = function() {
            info.innerText = "ERROR: NO EXISTE QSL PARA " + call;
            area.classList.add('hidden');
        };
    }

    /**
     * DESCARGA MASIVA (TU LÓGICA INTEGRADA)
     */
    function descargarIndividual(src, name) {
        const link = document.createElement('a');
        link.href = src;
        link.download = name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function descargarMasivo() {
        qslEncontradas.forEach((imgUrl, i) => {
            setTimeout(() => {
                descargarIndividual(imgUrl, `QSL_CL7ADV_${i}.jpg`);
            }, i * 300);
        });
    }

    /**
     * TIMER DE INACTIVIDAD DE 6 SEGUNDOS (TU LÓGICA INTEGRADA)
     */
    function startInactivityTimer() {
        clearTimeout(timerReinicio);
        document.getElementById('status-bar').innerText = "ESTADO: SESIÓN ACTIVA";
        timerReinicio = setTimeout(() => {
            resetUI();
        }, 6000); 
    }

    function resetUI() {
        document.getElementById('qslInput').value = "";
        document.getElementById('results-area').classList.add('hidden');
        document.getElementById('searchInfo').innerText = "";
        document.getElementById('status-bar').innerText = "ESTADO: STANDBY (RESET)";
    }

    // Resetear timer con movimiento
    document.addEventListener('mousemove', () => {
        if(!document.getElementById('results-area').classList.contains('hidden')) {
            startInactivityTimer();
        }
    });

    /**
     * MOTOR DE AUDIO PARA RADIO
     */
    let audioCtx, analyzer;
    async function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioCtx.createMediaStreamSource(stream);
        analyzer = audioCtx.createAnalyser();
        source.connect(analyzer);
        render();
        document.getElementById('term').innerText = "RECEPTOR ESCUCHANDO...";
    }

    function render() {
        const canvas = document.getElementById('spectrogram');
        const ctx = canvas.getContext('2d');
        const data = new Uint8Array(analyzer.frequencyBinCount);
        analyzer.getByteFrequencyData(data);
        ctx.fillStyle = '#000'; ctx.fillRect(0,0, canvas.width, canvas.height);
        for(let i=0; i<100; i++) {
            ctx.fillStyle = 'var(--neon-green)';
            ctx.fillRect(i*12, canvas.height - data[i]/2, 10, data[i]/2);
        }
        requestAnimationFrame(render);
    }

    function syncParams() {
        document.getElementById('fVal').innerText = document.getElementById('fSlider').value;
    }
</script>
</body>
</html>
