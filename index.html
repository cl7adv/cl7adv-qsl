<script>
  let totalQSLs = 0;
  let descargadas = 0;
  let listaActual = [];
  let imagenCargada = false; // üîπ variable global para saber si alguna imagen se carg√≥

  function buscarQSL() {
    const indicativo = document.getElementById("indicativo").value.trim().toUpperCase();
    const resultado = document.getElementById("resultado");

    if (!indicativo) {
      resultado.innerHTML = `<p class="mensaje">üå∫ Por favor escribe un indicativo</p>`;
      setTimeout(() => { resultado.innerHTML = ""; }, 5000);
      return;
    }

    let posibles = [];
    posibles.push(`img/${indicativo}.jpg`);
    for (let i = 1; i <= 50; i++) {
      posibles.push(`img/${indicativo}-${i}.jpg`);
    }

    let encontradas = [];

    posibles.forEach(ruta => {
      const img = new Image();
      img.onload = () => {
        imagenCargada = true; // ‚úÖ se carg√≥ al menos una
        encontradas.push(ruta);
        mostrarQSLs(encontradas, indicativo);
      };
      img.onerror = () => {
        // no hace nada, simplemente ignora si no existe
      };
      img.src = ruta;
    });

    // üîπ Espera 10 segundos antes de mostrar mensaje de error
    setTimeout(() => {
      if (!imagenCargada) {
        resultado.innerHTML = `<p class="mensaje">‚ùå No tenemos esa QSL, pero pronto estar√° lista. Gracias üå∫</p>`;
      }
    }, 10000);
  }

  function mostrarQSLs(lista, indicativo) {
    const ventana = document.getElementById("ventanaQSL");
    const listaQSLs = document.getElementById("listaQSLs");
    const contador = document.getElementById("contador");

    listaQSLs.innerHTML = `<p>üì° Se encontraron ${lista.length} QSL para <strong>${indicativo}</strong></p>`;
    totalQSLs = lista.length;
    descargadas = 0;
    listaActual = lista;

    actualizarContador();

    lista.forEach(ruta => {
      listaQSLs.innerHTML += `
        <div>
          <img src="${ruta}" alt="QSL de ${indicativo}" class="qsl-img">
          <br>
          <a href="${ruta}" download class="descargar" onclick="marcarDescarga()">‚¨áÔ∏è Descargar QSL</a>
        </div>
      `;
    });

    ventana.style.display = "block";
  }

  function actualizarContador() {
    const contador = document.getElementById("contador");
    contador.innerHTML = `<p class="mensaje">Has descargado ${descargadas} de ${totalQSLs} QSL</p>`;
  }

  function marcarDescarga() {
    descargadas++;
    actualizarContador();
    if (descargadas >= totalQSLs) {
      const listaQSLs = document.getElementById("listaQSLs");
      listaQSLs.innerHTML = `<p class="mensaje">‚úÖ Has descargado todas tus QSL, buenos DXs üå∫</p>`;
      setTimeout(() => {
        cerrarVentana();
        document.getElementById("resultado").innerHTML = "";
        document.getElementById("indicativo").value = "";
      }, 2000);
    }
  }

  function descargarTodas() {
    listaActual.forEach(ruta => {
      const link = document.createElement("a");
      link.href = ruta;
      link.download = ruta.split("/").pop();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      descargadas++;
    });
    actualizarContador();
    if (descargadas >= totalQSLs) {
      const listaQSLs = document.getElementById("listaQSLs");
      listaQSLs.innerHTML = `<p class="mensaje">‚úÖ Has descargado todas tus QSL, buenos DXs üå∫</p>`;
      setTimeout(() => {
        cerrarVentana();
        document.getElementById("resultado").innerHTML = "";
        document.getElementById("indicativo").value = "";
      }, 2000);
    }
  }

  function cerrarVentana() {
    const ventana = document.getElementById("ventanaQSL");
    ventana.style.display = "none";
  }
</script>

