<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Navegador QSL Caribe√±o - CL7ADV</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { margin: 0; font-family: "Trebuchet MS", Arial, sans-serif; background: linear-gradient(to bottom, #00bcd4, #009688); color: #fff; text-align: center; }
    .container { max-width: 900px; margin: 40px auto; padding: 25px; background: rgba(0,0,0,0.4); border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.6); }
    h1 { font-size: 2.2rem; margin-bottom: 15px; text-shadow: 0 0 10px #ffe082; }
    #indicativo { padding: 12px; font-size: 1rem; border: none; border-radius: 8px; margin-right: 10px; width: 220px; }
    #buscarBtn { padding: 12px 20px; font-size: 1rem; background: #ff9800; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
    #buscarBtn:hover { background: #f57c00; }
    #resultado { margin-top: 25px; }
    .qsl-img { max-width: 220px; border: 4px solid #ffe082; border-radius: 12px; margin: 10px; box-shadow: 0 0 15px #ffe082; }
    .descargar { display: inline-block; margin-top: 10px; padding: 8px 16px; background: #4caf50; color: white; border-radius: 8px; text-decoration: none; font-weight: bold; transition: 0.3s; }
    .descargar:hover { background: #388e3c; }
    .mensaje { font-size: 1.1rem; margin-top: 12px; color: #ffe082; text-shadow: 0 0 8px #ffeb3b; }
    footer { margin-top: 30px; font-size: 1rem; color: #ffe082; text-shadow: 0 0 8px #ffeb3b; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
    .modal-contenido { background: #fff; color: #000; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 900px; text-align: center; }
    .cerrar { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    #listaQSLs { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }

    /* Loader y barra con carta */
    .loader-wrap { display: none; margin-top: 12px; align-items: center; justify-content: center; }
    .spinner { width: 22px; height: 22px; border: 3px solid rgba(255,255,255,0.25); border-top-color: #ffe082; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar { position: relative; width: 360px; height: 14px; background: rgba(255,224,130,0.12); border-radius: 10px; overflow: hidden; box-shadow: inset 0 0 6px rgba(0,0,0,0.25); display: inline-block; vertical-align: middle; }
    .progress-fill { height: 100%; background: linear-gradient(90deg,#ffd54f,#ffb300); width: 0%; transition: width 200ms ease; }

    /* Transici√≥n m√°s r√°pida; movement will be animated via JS for smoothness */
    .card-thumb { position: absolute; top: -28px; width: 56px; height: 36px; background: linear-gradient(180deg,#fff,#ffe082); color: #000; border: 2px solid #ffd54f; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85rem; box-shadow: 0 4px 10px rgba(0,0,0,0.25); transform: translateX(-50%); transition: left 120ms cubic-bezier(.2,.8,.2,1); pointer-events: none; }
    .progress-text { font-size: 0.95rem; margin-top: 6px; color: #ffe082; }

    @media (max-width: 480px) {
      .progress-bar { width: 260px; }
      #indicativo { width: 140px; display: block; margin: 10px auto; }
      #buscarBtn { display: block; margin: 0 auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üå¥ Bienvenido al sitio QSL Caribe√±o üåä</h1>
    <p>Escribe tu indicativo para buscar tus tarjetas QSL</p>

    <div>
      <input type="text" id="indicativo" placeholder="Ej: CL7ADV" aria-label="Indicativo">
      <button id="buscarBtn" type="button">Buscar QSL</button>
    </div>

    <!-- Loader con carta movi√©ndose -->
    <div id="loaderContainer" class="loader-wrap" aria-hidden="true">
      <div class="spinner" id="spinner" role="status" aria-hidden="true"></div>
      <div>
        <div class="progress-bar" id="progressBar">
          <div id="progressFill" class="progress-fill" style="width:0%"></div>
          <div id="cardThumb" class="card-thumb" style="left:0%;">QSL</div>
        </div>
        <div id="progressText" class="progress-text">Iniciando b√∫squeda...</div>
      </div>
    </div>

    <div id="resultado" role="status" aria-live="polite"></div>

    <footer>
      ‚Äî CL7ADV ‚Äî Buenos DXs en este 2026<br>
      Motor del proyecto: Radio Club Santa Cruz Del Sur/Alfred
      <br><br>
      <a href="https://info.flagcounter.com/qvMz" target="_blank" rel="noopener">
        <img src="https://s01.flagcounter.com/count2/qvMz/bg_57A8DE/txt_000000/border_F55B0F/columns_5/maxflags_20/viewers_0/labels_0/pageviews_0/flags_0/percent_0/" alt="Flag Counter" border="0">
      </a>
    </footer>
  </div>

  <div id="ventanaQSL" class="modal" aria-hidden="true">
    <div class="modal-contenido" role="dialog" aria-modal="true" aria-labelledby="qslTitle">
      <span class="cerrar" id="cerrarBtn" title="Cerrar">&times;</span>
      <h2 id="qslTitle">QSLs disponibles</h2>
      <div id="contador"></div>
      <div id="listaQSLs"></div>
      <br>
      <button class="descargar" id="descargarTodasBtn" type="button">‚¨áÔ∏è Descargar todas</button>
    </div>
  </div>

  <script>
    // Variables globales
    let totalQSLs = 0;
    let descargadas = 0;
    let listaActual = [];
    let imagenCargada = false;
    let timeoutId = null;

    // Manejo de errores global para depuraci√≥n
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('ERROR GLOBAL:', message, 'at', source + ':' + lineno + ':' + colno);
      const resultado = document.getElementById('resultado');
      if (resultado) resultado.innerHTML = `<p class="mensaje">‚ö†Ô∏è Error: ${message} (ver consola)</p>`;
      return false;
    };

    // Asignar eventos cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('buscarBtn').addEventListener('click', buscarQSL);
      document.getElementById('cerrarBtn').addEventListener('click', cerrarVentana);
      document.getElementById('descargarTodasBtn').addEventListener('click', descargarTodas);
      // Cerrar modal al hacer click fuera del contenido
      document.getElementById('ventanaQSL').addEventListener('click', (e) => {
        if (e.target === document.getElementById('ventanaQSL')) cerrarVentana();
      });
    });

    // Animaci√≥n suave de la carta usando requestAnimationFrame
    function animateCardTo(cardElem, targetPct, duration = 140) {
      if (!cardElem) return;
      if (cardElem._animFrame) cancelAnimationFrame(cardElem._animFrame);
      const start = parseFloat(cardElem.style.left) || 0;
      const end = Math.max(0, Math.min(100, targetPct));
      const startTime = performance.now();

      function ease(t) {
        return t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t;
      }

      function step(now) {
        const t = Math.min(1, (now - startTime) / duration);
        const eased = ease(t);
        const current = start + (end - start) * eased;
        cardElem.style.left = current + '%';
        if (t < 1) {
          cardElem._animFrame = requestAnimationFrame(step);
        } else {
          cardElem._animFrame = null;
        }
      }
      cardElem._animFrame = requestAnimationFrame(step);
    }

    function buscarQSL() {
      // Reiniciar estado
      imagenCargada = false;
      if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; }

      const indicativo = document.getElementById("indicativo").value.trim().toUpperCase();
      const resultado = document.getElementById("resultado");
      const listaQSLs = document.getElementById("listaQSLs");

      // limpiar resultados previos
      resultado.innerHTML = "";
      listaQSLs.innerHTML = "";

      if (!indicativo) {
        resultado.innerHTML = `<p class="mensaje">üå∫ Por favor escribe un indicativo</p>`;
        setTimeout(() => { resultado.innerHTML = ""; }, 5000);
        return;
      }

      // Mostrar loader y resetear barra y carta
      const loader = document.getElementById('loaderContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const cardThumb = document.getElementById('cardThumb');
      loader.style.display = 'flex';
      loader.setAttribute('aria-hidden', 'false');
      progressFill.style.width = '0%';
      cardThumb.style.left = '0%';
      progressText.textContent = 'üîÑ Buscando QSL‚Ä¶ espera unos segundos';

      console.log('Buscando QSL para', indicativo);

      // Generar rutas posibles
      let posibles = [];
      posibles.push(`img/${indicativo}.jpg`);
      for (let i = 1; i <= 50; i++) posibles.push(`img/${indicativo}-${i}.jpg`);

      let encontradas = [];
      let comprobadas = 0;
      const totalPosibles = posibles.length;

      // cancelar timeout anterior si existe
      if (timeoutId) clearTimeout(timeoutId);

      // Helper para actualizar barra y mover carta (con offset para sensaci√≥n de avance)
      function actualizarProgreso() {
        const pct = Math.round((comprobadas / totalPosibles) * 100);
        progressFill.style.width = pct + '%';

        // Offset para que la carta vaya por delante del fill (ajusta entre 4 y 12)
        const offset = 10;
        const cardPos = Math.min(100, pct + offset);

        // Usar animaci√≥n suave
        animateCardTo(cardThumb, cardPos, 120);

        progressText.textContent = `Im√°genes comprobadas: ${comprobadas} / ${totalPosibles} (${pct}%)`;
      }

      posibles.forEach(ruta => {
        const img = new Image();
        img.onload = () => {
          comprobadas++;
          actualizarProgreso();

          if (!encontradas.includes(ruta)) {
            imagenCargada = true;
            encontradas.push(ruta);
            console.log('Imagen encontrada:', ruta);
            mostrarQSLs(encontradas, indicativo);
            // marcar barra completa y mover carta al final
            progressFill.style.width = '100%';
            animateCardTo(cardThumb, 100, 120);
            progressText.textContent = `Se encontraron ${encontradas.length} QSL`;
            // ocultar loader tras breve pausa
            setTimeout(() => { loader.style.display = 'none'; loader.setAttribute('aria-hidden','true'); }, 700);
          }
        };
        img.onerror = () => {
          comprobadas++;
          actualizarProgreso();
          if (comprobadas >= totalPosibles && !imagenCargada) {
            // ocultar loader y mostrar mensaje final
            setTimeout(() => { loader.style.display = 'none'; loader.setAttribute('aria-hidden','true'); }, 300);
          }
        };
        img.src = ruta;
      });

      // Esperar 10s antes de mostrar mensaje de no encontrada (fallback)
      timeoutId = setTimeout(() => {
        if (!imagenCargada) {
          resultado.innerHTML = `<p class="mensaje">‚ùå No tenemos esa QSL, pero pronto estar√° lista üå∫</p>`;
          progressText.textContent = 'B√∫squeda finalizada: no se encontraron im√°genes';
          // ocultar loader tras 1s
          setTimeout(() => { loader.style.display = 'none'; loader.setAttribute('aria-hidden','true'); }, 1000);
          console.log('No se encontraron im√°genes para', indicativo);
        }
      }, 10000);
    }

    function mostrarQSLs(lista, indicativo) {
      const ventana = document.getElementById("ventanaQSL");
      const listaQSLs = document.getElementById("listaQSLs");

      if (!lista || lista.length === 0) return;

      // Limpiar antes de a√±adir para evitar duplicados
      listaQSLs.innerHTML = `<p>üì° Se encontraron ${lista.length} QSL para <strong>${indicativo}</strong></p>`;
      totalQSLs = lista.length;
      descargadas = 0;
      listaActual = lista.slice();

      actualizarContador();

      lista.forEach(ruta => {
        listaQSLs.innerHTML += `
          <div>
            <img src="${ruta}" alt="QSL de ${indicativo}" class="qsl-img">
            <br>
            <a href="${ruta}" download class="descargar" onclick="marcarDescarga()">‚¨áÔ∏è Descargar QSL</a>
          </div>
        `;
      });

      ventana.style.display = "block";
      ventana.setAttribute('aria-hidden', 'false');
    }

    function actualizarContador() {
      const contador = document.getElementById("contador");
      contador.innerHTML = `<p class="mensaje">Has descargado ${descargadas} de ${totalQSLs} QSL</p>`;
    }

    function marcarDescarga() {
      descargadas++;
      actualizarContador();
      if (descargadas >= totalQSLs) {
        const listaQSLs = document.getElementById("listaQSLs");
        listaQSLs.innerHTML = `<p class="mensaje">‚úÖ Has descargado todas tus QSL, buenos DXs üå∫</p>`;
        setTimeout(() => {
          cerrarVentana();
          document.getElementById("resultado").innerHTML = "";
          document.getElementById("indicativo").value = "";
        }, 2000);
      }
    }

    function descargarTodas() {
      if (!listaActual || listaActual.length === 0) return;
      listaActual.forEach(ruta => {
        const link = document.createElement("a");
        link.href = ruta;
        link.download = ruta.split("/").pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        descargadas++;
      });
      actualizarContador();
      if (descargadas >= totalQSLs) {
        const listaQSLs = document.getElementById("listaQSLs");
        listaQSLs.innerHTML = `<p class="mensaje">‚úÖ Has descargado todas tus QSL, buenos DXs üå∫</p>`;
        setTimeout(() => {
          cerrarVentana();
          document.getElementById("resultado").innerHTML = "";
          document.getElementById("indicativo").value = "";
        }, 2000);
      }
    }

    function cerrarVentana() {
      const ventana = document.getElementById("ventanaQSL");
      ventana.style.display = "none";
      ventana.setAttribute('aria-hidden', 'true');
    }
  </script>
</body>
</html>
